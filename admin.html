<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <meta name="robots" content="noindex, nofollow">
    <title>Y√∂netim Paneli | OdyoCase</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ADMIN √ñZEL STƒ∞LLERƒ∞ */
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
        }

        label {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-bottom: 8px;
            display: block;
            font-weight: 600;
        }

        .secret-input {
            border-color: rgba(239, 68, 68, 0.5) !important;
            background: rgba(239, 68, 68, 0.05) !important;
        }

        /* TAB BUTONLARI */
        .mode-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: rgba(0, 0, 0, 0.2);
            padding: 5px;
            border-radius: 12px;
        }

        .tab-btn {
            flex: 1;
            padding: 12px;
            border: none;
            background: transparent;
            color: #94a3b8;
            font-weight: 700;
            cursor: pointer;
            border-radius: 8px;
            transition: 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .tab-btn.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
        }

        .tab-btn:hover:not(.active) {
            background: rgba(255, 255, 255, 0.05);
            color: white;
        }

        /* Lƒ∞STE ELEMANLARI */
        .admin-case-item {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border-color);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
    </style>
</head>

<body>

    <nav class="navbar">
        <a href="/" style="display: flex; align-items: center; text-decoration: none; gap: 0;">
            <svg width="34" height="34" viewBox="0 0 50 50" fill="none" xmlns="http://www.w3.org/2000/svg"
                style="margin-right: -1px;">
                <circle cx="25" cy="25" r="20" stroke="url(#gradO)" stroke-width="7" />
                <path d="M18 22V28" stroke="white" stroke-width="3" stroke-linecap="round" />
                <path d="M25 17V33" stroke="white" stroke-width="3" stroke-linecap="round" />
                <path d="M32 22V28" stroke="white" stroke-width="3" stroke-linecap="round" />
                <defs>
                    <linearGradient id="gradO" x1="0" y1="0" x2="50" y2="50" gradientUnits="userSpaceOnUse">
                        <stop stop-color="#3b82f6" />
                        <stop offset="1" stop-color="#1e40af" />
                    </linearGradient>
                </defs>
            </svg>
            <span style="font-size: 1.6rem; font-weight: 700; color: #fff; letter-spacing: -0.5px; line-height: 1;">
                dyo<span style="color: #3b82f6;">Case</span>
            </span>
        </a>

        <div style="display:flex; align-items:center; gap:15px;">
            <span style="color:#94a3b8; font-weight:600; font-size:0.9rem; text-transform: uppercase;">Y√∂netim
                Paneli</span>
            <a href="/" class="nav-profil">
                <i class="fas fa-home"></i> Ana Sayfaya D√∂n
            </a>
        </div>
    </nav>

    <div class="container">

        <div class="card">
            <div class="mode-tabs">
                <button class="tab-btn active" onclick="modDegistir('klasik', event)">
                    <i class="fas fa-folder"></i> Klasik Vaka Ekle
                </button>
                <button class="tab-btn" onclick="modDegistir('simulasyon', event)">
                    <i class="fas fa-user-md"></i> Klinik Sim√ºlasyon Ekle
                </button>
            </div>

            <div class="form-grid">
                <div><label>Vaka Ba≈ülƒ±ƒüƒ±</label><input type="text" id="genel-baslik"
                        placeholder="√ñrn: Ani ƒ∞≈üitme Kaybƒ±"></div>
                <div><label>Hasta Ya≈üƒ±</label><input type="number" id="genel-yas" placeholder="45"></div>
                <div><label>Cinsiyet</label><select id="genel-cinsiyet">
                        <option>Erkek</option>
                        <option>Kadƒ±n</option>
                        <option>√áocuk</option>
                    </select></div>
                <div><label>Zorluk</label><select id="genel-zorluk">
                        <option>Kolay</option>
                        <option selected>Orta</option>
                        <option>Zor</option>
                    </select></div>
            </div>

            <div id="form-klasik">
                <div class="form-grid" style="margin-top:15px;">
                    <div><label style="color:var(--danger);">Gizli Tanƒ± (AI ƒ∞√ßin)</label><input type="text"
                            id="klasik-tani" class="secret-input" placeholder="Ger√ßek tanƒ± ne?"></div>
                    <div><label>G√∂rsel (Opsiyonel)</label><input type="file" id="klasik-resim"></div>
                </div>
                <div style="margin-top: 15px;">
                    <label>Vaka Hikayesi (Metin)</label>
                    <textarea id="klasik-icerik" rows="5"
                        placeholder="Hastanƒ±n ≈üikayetini ve √∂yk√ºs√ºn√º buraya yazƒ±n..."></textarea>
                </div>
            </div>

            <div id="form-simulasyon" style="display:none;">
                <div class="form-grid" style="margin-top:15px;">
                    <div><label>Geli≈ü ≈ûikayeti</label><input type="text" id="sim-sikayet" placeholder="Hasta ne diyor?">
                    </div>
                    <div><label style="color:var(--danger);">Ger√ßek Tanƒ±</label><input type="text" id="sim-tani"
                            class="secret-input"></div>
                </div>

                <h3
                    style="margin:20px 0 10px 0; color:var(--primary); border-bottom:1px solid rgba(255,255,255,0.1); font-size:0.9rem;">
                    TEMEL TESTLER</h3>
                <div class="form-grid">
                    <div><label>Anamnez Detayƒ±</label><textarea id="sim-anamnez" rows="1"></textarea></div>
                    <div><label>Otoskopi</label><textarea id="sim-otoskopi" rows="1"></textarea></div>
                    <div><label>Saf Ses Odyo</label><textarea id="sim-safses" rows="1"></textarea></div>
                    <div><label>Konu≈üma (SRT/SDS)</label><textarea id="sim-konusma" rows="1"></textarea></div>
                    <div><label>Timpanometri</label><textarea id="sim-timpano" rows="1"></textarea></div>
                    <div><label>Akustik Refleks</label><textarea id="sim-refleks" rows="1"></textarea></div>
                </div>

                <h3
                    style="margin:20px 0 10px 0; color:var(--accent); border-bottom:1px solid rgba(255,255,255,0.1); font-size:0.9rem;">
                    ƒ∞LERƒ∞ TESTLER & ELEKTROFƒ∞ZYOLOJƒ∞</h3>
                <div class="form-grid">
                    <div><label>Y√ºksek Frekans Odyo</label><textarea id="sim-yuksekfrekans" rows="1"
                            placeholder="10-16 kHz..."></textarea></div>
                    <div><label>Tone Decay</label><textarea id="sim-tonedecay" rows="1"
                            placeholder="Var/Yok"></textarea></div>
                    <div><label>SISI Testi</label><textarea id="sim-sisi" rows="1" placeholder="% Skor"></textarea>
                    </div>
                    <div><label>ABLB</label><textarea id="sim-ablb" rows="1" placeholder="Rekruitment..."></textarea>
                    </div>

                    <div><label>DPOAE</label><textarea id="sim-dpoae" rows="1"></textarea></div>
                    <div><label>TEOAE</label><textarea id="sim-teoae" rows="1"></textarea></div>

                    <div><label>ABR / BERA</label><textarea id="sim-abr" rows="1"></textarea></div>
                    <div><label>ASSR</label><textarea id="sim-assr" rows="1"></textarea></div>
                    <div><label>EcochG</label><textarea id="sim-ecochg" rows="1"></textarea></div>
                    <div><label>CAEP (Kortikal)</label><textarea id="sim-caep" rows="1"></textarea></div>
                </div>

                <div style="margin-top:15px;">
                    <label style="color:var(--danger);">‚ö†Ô∏è Gereksiz/Yasak Testler</label>
                    <input type="text" id="sim-gereksiz" placeholder="√ñrn: ƒ∞letim tipinde refleks bakƒ±lmaz...">
                </div>

                <div style="margin-top:15px;">
                    <label style="color:var(--secondary);"><i class="fas fa-lightbulb"></i> ƒ∞pucu (Opsiyonel)</label>
                    <textarea id="sim-ipucu" rows="2" placeholder="√ñƒürencilere verilecek ipucu..."></textarea>
                </div>
            </div>

            <button id="btn-kaydet" onclick="islemYap()" class="admin-btn-save"><i class="fas fa-save"></i> Klasik Vaka
                Kaydet</button>
            <p id="sonuc" style="margin-top:15px; text-align:center; font-weight:600;"></p>
        </div>

        <div class="card">
            <h2 id="liste-baslik"><i class="fas fa-list"></i> Mevcut Vakalar</h2>
            <div id="yonetim-listesi">
                <p>Y√ºkleniyor...</p>
            </div>
        </div>

        <div class="card" style="border-left: 5px solid var(--accent);">
            <h2 style="margin-top:0; color:var(--text-main); margin-bottom: 20px;">
                <i class="fas fa-envelope-open-text" style="color:var(--accent);"></i> Geri Bildirimler
            </h2>
            <div id="feedback-listesi">
                <p>Mesajlar y√ºkleniyor...</p>
            </div>
        </div>

        <div class="card" style="border-left: 5px solid #3b82f6;">
            <h2 style="margin-top:0; color:var(--text-main); margin-bottom: 20px;">
                <i class="fas fa-paper-plane" style="color:#3b82f6;"></i> E-posta Bildirimi G√∂nder
            </h2>
            <p style="color:var(--text-muted); margin-bottom:15px; font-size:0.9rem;">
                T√ºm kayƒ±tlƒ± kullanƒ±cƒ±lara toplu e-posta g√∂nderir.
            </p>
            <label>Konu</label>
            <input type="text" id="bildirim-konu" placeholder="√ñrn: Yeni Vakalar Eklendi! üéâ">
            <label>Mesaj ƒ∞√ßeriƒüi</label>
            <textarea id="bildirim-mesaj" rows="4"
                placeholder="Kullanƒ±cƒ±lara g√∂ndermek istediƒüiniz mesajƒ± yazƒ±n..."></textarea>
            <button onclick="bildirimGonder()"
                style="width:100%; padding:14px; margin-top:10px; background:linear-gradient(135deg, #3b82f6, #1e40af); color:white; border:none; border-radius:10px; font-size:1rem; font-weight:700; cursor:pointer; transition:0.3s;">
                <i class="fas fa-paper-plane"></i> T√ºm Kullanƒ±cƒ±lara G√∂nder
            </button>
            <p id="bildirim-sonuc" style="margin-top:10px; text-align:center; font-weight:600;"></p>
        </div>

    </div>

    <script>
        // GLOBAL DEƒûƒ∞≈ûKENLER
        let aktifMod = 'klasik'; // 'klasik' veya 'simulasyon'
        let duzenlemeModu = false;
        let seciliId = null;
        const adminToken = localStorage.getItem('token');

        // Auth header'lƒ± fetch yardƒ±mcƒ±sƒ±
        function adminFetch(url, options = {}) {
            options.headers = {
                ...options.headers,
                'Authorization': adminToken
            };
            return fetch(url, options);
        }

        // XSS korumasƒ±
        function safeHTML(str) {
            if (!str) return '';
            const d = document.createElement('div');
            d.textContent = str;
            return d.innerHTML;
        }

        // --- Bƒ∞LDƒ∞Rƒ∞M VE ONAY FONKSƒ∞YONLARI ---
        function showToast(mesaj, tip = 'info') {
            let container = document.getElementById('toast-container');
            if (!container) { container = document.createElement('div'); container.id = 'toast-container'; document.body.appendChild(container); }
            const iconMap = { 'success': 'fa-check-circle', 'error': 'fa-times-circle', 'warning': 'fa-exclamation-triangle', 'info': 'fa-info-circle' };
            const toast = document.createElement('div'); toast.className = `toast toast-${tip}`;
            toast.innerHTML = `<i class="fas ${iconMap[tip] || 'fa-info-circle'}"></i><span>${mesaj}</span>`;
            container.appendChild(toast); setTimeout(() => toast.remove(), 3000);
        }

        function showConfirm(mesaj, callback) {
            const eski = document.querySelector('.confirm-overlay'); if (eski) eski.remove();
            const overlay = document.createElement('div'); overlay.className = 'confirm-overlay';
            overlay.innerHTML = `<div class="confirm-box"><i class="fas fa-question-circle" style="font-size:3rem; color:#f59e0b; margin-bottom:15px; display:block;"></i><h3 style="margin:0 0 10px 0; color:white;">Emin misiniz?</h3><p style="color:#94a3b8; margin:0;">${mesaj}</p><div class="confirm-buttons"><button class="btn-confirm-no" id="btn-iptal">Vazge√ß</button><button class="btn-confirm-yes" id="btn-onayla">Evet, Yap</button></div></div>`;
            document.body.appendChild(overlay);
            document.getElementById('btn-iptal').onclick = () => overlay.remove();
            document.getElementById('btn-onayla').onclick = () => { overlay.remove(); callback(); };
        }

        document.addEventListener("DOMContentLoaded", function () {
            listele();
            feedbacksGetir();
        });

        // --- MOD DEƒûƒ∞≈ûTƒ∞RME ---
        function modDegistir(mod, e) {
            aktifMod = mod;
            formuSifirla(); // Mod deƒüi≈üince formu temizle

            // Tab Stilleri
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            if (e && e.currentTarget) e.currentTarget.classList.add('active');

            // Form G√∂ster/Gizle
            document.getElementById('form-klasik').style.display = (mod === 'klasik') ? 'block' : 'none';
            document.getElementById('form-simulasyon').style.display = (mod === 'simulasyon') ? 'block' : 'none';

            // Buton Yazƒ±sƒ± ve Liste Ba≈ülƒ±ƒüƒ±
            guncelleButonveBaslik();
            listele();
        }

        function guncelleButonveBaslik() {
            const btn = document.getElementById('btn-kaydet');
            const baslik = document.getElementById('liste-baslik');

            if (duzenlemeModu) {
                btn.innerHTML = `<i class="fas fa-sync-alt"></i> #${seciliId} Nolu Kaydƒ± G√ºncelle`;
                btn.style.background = "var(--accent)";
            } else {
                if (aktifMod === 'klasik') {
                    btn.innerHTML = '<i class="fas fa-save"></i> Klasik Vaka Kaydet';
                    btn.style.background = '';
                    baslik.innerHTML = '<i class="fas fa-list"></i> Klasik Vakalar';
                } else {
                    btn.innerHTML = '<i class="fas fa-user-md"></i> Sim√ºlasyon Hastasƒ± Ekle';
                    btn.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                    baslik.innerHTML = '<i class="fas fa-users"></i> Sim√ºlasyon Hastalarƒ±';
                }
            }
        }

        // --- D√úZENLEME MODUNU A√á ---
        async function duzenle(id) {
            showToast("Veriler getiriliyor...", "info");

            try {
                // Hangi moddaysak ona g√∂re veri √ßek
                const url = (aktifMod === 'klasik') ? `/admin/case/${id}` : `/simulation/${id}`;
                const res = await adminFetch(url);
                const data = await res.json();

                if (data.success) {
                    const veri = data.vaka || data.sim; // Klasik i√ßin 'vaka', Sim√ºlasyon i√ßin 'sim' d√∂n√ºyor

                    // Ortak Alanlarƒ± Doldur
                    document.getElementById('genel-baslik').value = veri.baslik;
                    document.getElementById('genel-yas').value = veri.yas;
                    document.getElementById('genel-cinsiyet').value = veri.cinsiyet;
                    document.getElementById('genel-zorluk').value = veri.zorluk || 'Orta';

                    if (aktifMod === 'klasik') {
                        document.getElementById('klasik-tani').value = veri.gizliTani;
                        document.getElementById('klasik-icerik').value = veri.icerik;
                    } else {
                        document.getElementById('sim-sikayet').value = veri.sikayet;
                        document.getElementById('sim-tani').value = veri.gercekTani;
                        document.getElementById('sim-anamnez').value = veri.anamnez;
                        document.getElementById('sim-otoskopi').value = veri.otoskopi;
                        document.getElementById('sim-safses').value = veri.safSes;
                        document.getElementById('sim-timpano').value = veri.timpanometri;
                        document.getElementById('sim-refleks').value = veri.refleks;
                        document.getElementById('sim-konusma').value = veri.konusma;
                        document.getElementById('sim-yuksekfrekans').value = veri.yuksekFrekans || '';
                        document.getElementById('sim-tonedecay').value = veri.toneDecay || '';
                        document.getElementById('sim-sisi').value = veri.sisi || '';
                        document.getElementById('sim-ablb').value = veri.ablb || '';
                        document.getElementById('sim-dpoae').value = veri.dpoae || '';
                        document.getElementById('sim-teoae').value = veri.teoae || '';
                        document.getElementById('sim-abr').value = veri.abr || '';
                        document.getElementById('sim-assr').value = veri.assr || '';
                        document.getElementById('sim-ecochg').value = veri.ecochg || '';
                        document.getElementById('sim-caep').value = veri.caep || '';
                        document.getElementById('sim-gereksiz').value = veri.gereksizTestler || '';
                        document.getElementById('sim-ipucu').value = veri.ipucu || '';
                    }

                    // Modu G√ºncelle
                    duzenlemeModu = true;
                    seciliId = id;
                    guncelleButonveBaslik();

                    // ƒ∞ptal butonu ekle
                    if (!document.getElementById('btn-iptal-form')) {
                        const iptalBtn = document.createElement('button');
                        iptalBtn.id = 'btn-iptal-form';
                        iptalBtn.innerText = "ƒ∞ptal";
                        iptalBtn.style = "width:100%; margin-top:10px; background:#475569; color:white; padding:10px; border:none; border-radius:10px; cursor:pointer;";
                        iptalBtn.onclick = formuSifirla;
                        document.getElementById('btn-kaydet').parentNode.appendChild(iptalBtn);
                    }

                    // Sayfayƒ± yukarƒ± kaydƒ±r
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            } catch (e) { showToast("Veri √ßekilemedi.", "error"); }
        }

        function formuSifirla() {
            duzenlemeModu = false;
            seciliId = null;

            // T√ºm inputlarƒ± temizle
            document.querySelectorAll('input, textarea').forEach(el => el.value = '');
            document.querySelectorAll('select').forEach(el => el.selectedIndex = 0);

            const iptalBtn = document.getElementById('btn-iptal-form');
            if (iptalBtn) iptalBtn.remove();

            guncelleButonveBaslik();
        }

        // --- KAYDET / G√úNCELLE ---
        async function islemYap() {
            const baslik = document.getElementById('genel-baslik').value;
            const yas = document.getElementById('genel-yas').value;
            const cinsiyet = document.getElementById('genel-cinsiyet').value;
            const zorluk = document.getElementById('genel-zorluk').value;

            if (!baslik || !yas) { showToast("Ba≈ülƒ±k ve ya≈ü zorunludur.", "warning"); return; }

            const btn = document.getElementById('btn-kaydet');
            const orjText = btn.innerHTML;
            btn.innerHTML = "ƒ∞≈ülem Yapƒ±lƒ±yor...";
            btn.disabled = true;

            let url, method, bodyData, headers = {};

            // URL ve Metot Belirleme
            if (duzenlemeModu) {
                method = 'PUT';
                url = (aktifMod === 'klasik') ? `/admin/update-case/${seciliId}` : `/admin/update-simulation/${seciliId}`;
            } else {
                method = 'POST';
                url = (aktifMod === 'klasik') ? '/admin/add-case' : '/admin/add-simulation';
            }

            // Veri Hazƒ±rlama
            if (aktifMod === 'klasik') {
                const formData = new FormData();
                formData.append('baslik', baslik); formData.append('yas', yas);
                formData.append('cinsiyet', cinsiyet); formData.append('zorluk', zorluk);
                formData.append('gizliTani', document.getElementById('klasik-tani').value);
                formData.append('icerik', document.getElementById('klasik-icerik').value);
                const resim = document.getElementById('klasik-resim').files[0];
                if (resim) formData.append('vakaResmi', resim);

                bodyData = formData; // Klasikte FormData (Resim i√ßin)
            } else {
                headers = { 'Content-Type': 'application/json' };
                bodyData = JSON.stringify({
                    baslik, yas, cinsiyet, zorluk,
                    sikayet: document.getElementById('sim-sikayet').value,
                    gercekTani: document.getElementById('sim-tani').value,
                    anamnez: document.getElementById('sim-anamnez').value,
                    otoskopi: document.getElementById('sim-otoskopi').value,
                    safSes: document.getElementById('sim-safses').value,
                    timpanometri: document.getElementById('sim-timpano').value,
                    refleks: document.getElementById('sim-refleks').value,
                    konusma: document.getElementById('sim-konusma').value,
                    yuksekFrekans: document.getElementById('sim-yuksekfrekans').value,
                    toneDecay: document.getElementById('sim-tonedecay').value,
                    sisi: document.getElementById('sim-sisi').value,
                    ablb: document.getElementById('sim-ablb').value,
                    dpoae: document.getElementById('sim-dpoae').value,
                    teoae: document.getElementById('sim-teoae').value,
                    abr: document.getElementById('sim-abr').value,
                    assr: document.getElementById('sim-assr').value,
                    ecochg: document.getElementById('sim-ecochg').value,
                    caep: document.getElementById('sim-caep').value,
                    gereksizTestler: document.getElementById('sim-gereksiz').value,
                    ipucu: document.getElementById('sim-ipucu').value
                });
            }

            try {
                const res = await adminFetch(url, { method: method, headers: headers, body: bodyData });
                const data = await res.json();

                if (data.success) {
                    showToast(data.message, "success");
                    formuSifirla();
                    listele();
                } else {
                    showToast(data.message, "error");
                }
            } catch (e) { showToast("Hata olu≈ütu.", "error"); }

            btn.innerHTML = orjText;
            btn.disabled = false;
        }

        // --- Lƒ∞STELEME ---
        async function listele() {
            const kutu = document.getElementById('yonetim-listesi');
            kutu.innerHTML = "Y√ºkleniyor...";
            const url = (aktifMod === 'klasik') ? '/cases' : '/simulations';

            try {
                const res = await fetch(url);
                const veriler = await res.json();
                kutu.innerHTML = "";

                if (veriler.length === 0) { kutu.innerHTML = "<p style='color:#aaa; padding:10px;'>Kayƒ±t bulunamadƒ±.</p>"; return; }

                veriler.reverse().forEach(v => {
                    const id = v.vakaNo || v.simNo;
                    kutu.innerHTML += `
                        <div class="admin-case-item">
                            <div><strong>#${id}</strong> ${v.baslik}</div>
                            <div style="display:flex; gap:10px;">
                                <button onclick="duzenle(${id})" style="background:var(--accent); color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer; font-weight:bold;">D√ºzenle</button>
                                <button onclick="sil(${id})" class="delete-btn" style="background:rgba(239,68,68,0.2); color:#ef4444; border:none; padding:5px 10px; border-radius:5px; cursor:pointer;">Sil</button>
                            </div>
                        </div>
                    `;
                });
            } catch (e) { kutu.innerHTML = "Baƒülantƒ± hatasƒ±."; }
        }

        // --- Sƒ∞LME ---
        async function sil(id) {
            showConfirm(`Kayƒ±t #${id} silinecek. Emin misin?`, async () => {
                const url = (aktifMod === 'klasik') ? `/admin/delete-case/${id}` : `/admin/delete-simulation/${id}`;

                try {
                    const res = await adminFetch(url, { method: 'DELETE' });
                    const data = await res.json();
                    if (data.success) { showToast("Silindi.", "success"); listele(); }
                    else showToast(data.message || "Silinemedi.", "error");
                } catch (e) { showToast("Hata.", "error"); }
            });
        }

        // --- FEEDBACK Y√ñNETƒ∞Mƒ∞ ---
        async function feedbacksGetir() {
            const div = document.getElementById('feedback-listesi');
            try {
                const res = await adminFetch('/admin/feedbacks');
                const msgs = await res.json();
                div.innerHTML = "";
                if (!msgs.length) { div.innerHTML = "<p style='color:#aaa; padding:10px;'>Mesaj yok.</p>"; return; }
                msgs.forEach(m => {
                    const tarih = new Date(m.tarih).toLocaleDateString('tr-TR');
                    const op = m.okundu ? '0.5' : '1';
                    div.innerHTML += `
                        <div style="background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); padding:15px; border-radius:10px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center; opacity:${op};">
                            <div>
                                <strong style="color:var(--primary);">${safeHTML(m.kullaniciAdi)}</strong> <small style="color:#aaa;">${tarih}</small>
                                <div style="color:white; margin-top:5px;">${safeHTML(m.mesaj)}</div>
                            </div>
                            <div>
                                <button onclick="durumDegistir('${m._id}')" style="background:transparent; border:none; cursor:pointer; color:var(--secondary); font-size:1.2rem; margin-right:10px;"><i class="fas fa-check-circle"></i></button>
                                <button onclick="feedbackSil('${m._id}')" style="background:transparent; border:none; cursor:pointer; color:var(--danger); font-size:1.2rem;"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                    `;
                });
            } catch (e) { }
        }

        async function durumDegistir(id) { await adminFetch('/admin/toggle-feedback/' + id, { method: 'PUT' }); feedbacksGetir(); }
        async function feedbackSil(id) {
            showConfirm("Mesaj silinsin mi?", async () => {
                await adminFetch('/admin/delete-feedback/' + id, { method: 'DELETE' }); feedbacksGetir();
            });
        }

        // --- Bƒ∞LDƒ∞Rƒ∞M G√ñNDERƒ∞Mƒ∞ ---
        async function bildirimGonder() {
            const konu = document.getElementById('bildirim-konu').value.trim();
            const mesaj = document.getElementById('bildirim-mesaj').value.trim();
            const sonuc = document.getElementById('bildirim-sonuc');

            if (!konu || !mesaj) {
                showToast("Konu ve mesaj alanlarƒ± zorunludur.", "warning");
                return;
            }

            sonuc.style.color = "var(--primary)";
            sonuc.innerText = "üìß G√∂nderiliyor...";

            try {
                const res = await adminFetch('/admin/send-notification', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ subject: konu, message: mesaj })
                });
                const data = await res.json();

                if (data.success) {
                    sonuc.style.color = "var(--secondary)";
                    sonuc.innerText = "‚úÖ " + data.message;
                    document.getElementById('bildirim-konu').value = '';
                    document.getElementById('bildirim-mesaj').value = '';
                    showToast(data.message, "success");
                } else {
                    sonuc.style.color = "var(--danger)";
                    sonuc.innerText = "‚ùå " + (data.message || "G√∂nderilemedi.");
                    showToast(data.message || "G√∂nderilemedi.", "error");
                }
            } catch (e) {
                sonuc.style.color = "var(--danger)";
                sonuc.innerText = "‚ùå Baƒülantƒ± hatasƒ±!";
                showToast("Baƒülantƒ± hatasƒ±!", "error");
            }
        }
    </script>
</body>

</html>